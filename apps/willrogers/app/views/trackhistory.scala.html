@(grList: Seq[willrogers.controllers.TrackHistoryPage.trackHistory.GoalRun])

@import helper._
@import scala.collection.JavaConversions._
@import satisfaction._
@import satisfaction.engine._
@import satisfaction.engine.actors._
@import models.HtmlUtil


@main("Track History Page") {
	<div id="filterMenu">
		<h2> Filtering Menu for Track History</h2>
		<p> Ideas - each bullet is an "AND" </p>
		<ul>
			<li>start time filtering (beginning and end)</li>
			<li> ditto for end time </li>
			<li> track name contains </li>
			<li> goal name contains </li>
			<li> percentage complete (want a 2 way slider - if possible)</li>
		</ul>
		
		
		<label style="width:200px;float:left">Track Name contains : </label>
		<input type=text id="trackNameSearch">
		
	</div>
	
	<div id="trackHistoryContainer">
		<h2>Track History</h2>
		<div id="trackHistory" style="height:600px;"></div>
	</div>
	

	<script type="text/javascript" charset="utf8" src="@routes.Assets.at("javascripts/jquery.event.drag-2.2.js")"></script>
	<script type="text/javascript" charset="utf8" src="@routes.Assets.at("javascripts/slick.core.js")"></script>
   	<script type="text/javascript" charset="utf8" src="@routes.Assets.at("javascripts/slick.grid.js")"></script>
 	 <script type="text/javascript" charset="utf8" src="@routes.Assets.at("javascripts/slick.dataview.js")"></script>
 	
 	<script>
 	  
    
    	var dataView = new Slick.Data.DataView();
 		var grid;
 		var data = [];
 		var columns = [
 	                   {id: "id", name: "ID", field: "id", sortable: true},
 	                   {id: "trackName", name: "Track Name", field: "trackName", sortable: true},
 	                   {id: "goalName", name: "GoalName", field: "goalName", sortable: true},
 	                   {id: "witness", name: "Witness", field: "witness", formatter: formatter, sortable: true},
 	                   {id: "startTime", name: "Start Time", field: "startTime", sortable: true},
 	                   {id: "endTime", name: "End Time", field: "endTime", sogrtable: true},
 	                   {id: "status", name: "Status", field: "status", sortable: true},
 	                   {id: "log", name: "Log File", field: "log", formatter: formatter, sortable: true}
 	              ];

 	    var options = {
 	    	    enableCellNavigation: true,
 	            enableColumnReorder :false,
 	            forceFitColumns: true
 	            };
 	            
 	            

		var sortcol = "startTime"
		var sortdir =1;
		trackNameSearchString="";
		
		//to display HTML content in cell.      
 	   function formatter(row, cell, value, columnDef, dataContext) {
        	return value;
        }
        
       //put all filtering conds in this function
       function myFilter(item, args) {
       	if(args.trackNameSearchString != "" && item["trackName"].indexOf(args.trackNameSearchString) == -1) {
       		return false;
       	}
       	return true;
       }
 	   
 	   $(function () {
 	   
 	   		//load data
			@grList.map { gr => 
				data[@grList.length - @gr.runId] = {
					id: @gr.runId,
					trackName: "@gr.trackDescriptor.trackName",
	  	          	goalName: "@gr.goalName",
	  	          	witness: "@Html(HtmlUtil.witnessTable( gr.witness))",
	  	          	startTime: "@HtmlUtil.formatTrackHistoryDate(Some(gr.startTime))", 
	  	          	endTime: "@HtmlUtil.formatTrackHistoryDate(gr.endTime)",
	  	          	status: "@gr.state",
	  	          	log:"@Html({
								var logWindowUrl = "/logwindow/"+gr.trackDescriptor.trackName.replace(" ", "_")+"/"+gr.goalName.replace(" ", "_")+"/"+{HtmlUtil.witnessPath(gr.witness)}.replace(" ", "_")
								s"<a href='$logWindowUrl'>View Log for Goal</a>"
							})"
				};
			}

 	      	grid = new Slick.Grid("#trackHistory", dataView, columns, options);
 	      	
 	      	//listeners and functions for sorting
 	      	function comparer(a,b) {
 	      		if (sortcol == "startTime" || sortcol=="endTime") {
 	      			var x = Date(a[sortcol]).parse();
 	      			var y = Date(b[sortcol]).parse();
 	      		} else {
 	      			var x = a[sortcol]
 	      			var y = b[sortcol];
 	      		}
                return (x == y ? 0 : (x > y ? 1 : -1));
 	      	}
            
            grid.onSort.subscribe(function(e, args) {
                sortdir = args.sortAsc ? 1 : -1;
                sortcol = args.sortCol.field;
                dataView.sort(comparer, args.sortAsc);
            });

			//filtering wires
            dataView.onRowsChanged.subscribe(function (e,args) {
			    grid.invalidateRows(args.rows);
			    grid.render();
			});
			
			dataView.onRowsChanged.subscribe(function (e, args) {
			    grid.invalidateRows(args.rows);
			    grid.render();
			  });
			  
			$('#trackNameSearch').keyup(function (e) {
				Slick.GlobalEditorLock.cancelCurrentEdit();
				
				if (e.which == 27) {
					this.value = "";
				}
				trackNameSearchString=this.value;
				updateFilter();
				
			});
			
			function updateFilter() {
				dataView.setFilterArgs({
					trackNameSearchString: trackNameSearchString
				});
				render();
				
				
				
			}
			
			
			//it's rendering time
            function render() {
            	dataView.beginUpdate();
	            dataView.setItems(data);
	            dataView.setFilterArgs({
	            	trackNameSearchString: trackNameSearchString
	            });
	            dataView.setFilter(myFilter);
	            dataView.endUpdate();
	            dataView.refresh();
				grid.invalidate();
				$("#myGrid").show();
	            $('.slick-header-columns').children().eq(4).trigger('dblclick');
	            console.log(dataView.getLength() +" tracks to display")
            }
            
            render();
 	        })
        
 	</script>
  

	}